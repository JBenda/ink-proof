<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Ink Proof</title>
    <link rel="stylesheet" href="https://unpkg.com/tachyons@4.12.0/css/tachyons.min.css"/>
  </head>
  <body>
    <main class="sans-serif"></main>
    <script src="https://unpkg.com/mithril/mithril.js"></script>
    <script>
      const Rollover = {
        current: null,
      };

      const Data = {
        data: {},
        examples: [],
        programs: [],
        results: [],
        statuses: {},
        exampleByName: {},
        programByName: {},
        resultByProgramExample: {},

        getResult(program, example) {
          if (this.resultByProgramExample[program.name] === undefined) {
            return null;
          }
          if (this.resultByProgramExample[program.name][example.name] === undefined) {
            return null;
          }
          return this.resultByProgramExample[program.name][example.name];
        },

        load() {
          return m.request({
            method: "GET",
            url: "summary.json",
          }).then(result => {
            Data.data = result;
            Data.examples = result.examples;
            Data.programs = result.programs;
            Data.results = result.results;
            Data.statuses = result.statuses;

            const exampleByName = {};
            const programByName = {};
            const resultByProgramExample = {};
            for (const example of result.examples) {
              exampleByName[example.name] = example;
            }
            for (const program of result.programs) {
              programByName[program.name] = program;
              resultByProgramExample[program.name] = {};
            }
            for (const r of result.results) {
              if (resultByProgramExample[r.program] === undefined) {
                resultByProgramExample[r.program] = {};
              }
              resultByProgramExample[r.program][r.example] = r;
            }
            Data.exampleByName = exampleByName;
            Data.programByName = programByName;
            Data.resultByProgramExample = resultByProgramExample;
          });
        },
      };

      const Files = {
        cached: {},
        pending: {},

        get(path) {
          if (this.cached[path] !== undefined) {
            return this.cached[path];
          }
          if (this.pending[path]) {
            return '';
          }
          this.pending[path] = true;
          m.request({
            method: "GET",
            responseType: "text",
            url: path,
          }).then(result => {
            Files.pending[path] = false;
            Files.cached[path] = result;
          });
        }
      };

      const FocusExample = {
        view(vnode) {
          const example = Data.exampleByName[vnode.attrs.exampleName];
          return [
            m("h1",
              "Example ",
              vnode.attrs.exampleName, " ",
              m("span.f3.gray", example.metadata.oneLineDescription)),
            m(".fl.w-50.pr2",
              m("p", "Bytecode"),
              m(FileView, {path: example.sourcePath}),
            ),
            m(".fl.w-50",
              m("p", "Input"),
              m(FileView, {path: example.inputPath}),
            ),
          ];
        }
      };

      const FocusNothing = {
        view() {
          return null;
        }
      };

      const FileView = {
        view(vnode) {
          const text = Files.get(vnode.attrs.path);
          return text === "" ? m('p', m("i.gray", "Empty file")) : m("pre", {
            style: "white-space: pre-wrap; tab-size: 4;",
          }, text);
        },
      };

      const FocusFile = {
        view(vnode) {
          return [
            m("p", m("a[href=''].link", {onclick: e => {
              e.preventDefault();
              history.back();
            }}, "Back")),
            m("code", vnode.attrs.path),
            m(FileView, {path: vnode.attrs.path}),
          ];
        },
      };

      const FocusGolden = {
        view(vnode) {
          const example = Data.exampleByName[vnode.attrs.exampleName];
          return [
            m('h1', "Expected output for ", vnode.attrs.exampleName),
            m(FileView, {path: example.expectedPath}),
          ];
        }
      };

      const FocusProgram = {
        view(vnode) {
          const program = Data.programByName[vnode.attrs.programName];
          return [
            m('h1', program.kind, " ", program.name),
          ];
        }
      };

      const FocusMetadata = {
        view(vnode) {
          return [
            m('h1', "Metadata"),
          ];
        }
      };

      const FocusHelp = {
        view(vnode) {
          const program = Data.programByName[vnode.attrs.programName];
          return [
            m("h1", "Help"),
            m("p.mw6",
              "This is ink-proof, a tool for acceptance testing of Ink compilers and runtimes.",
              " ",
              "Try clicking on an item in the grid on the left for more detail on it.",
              " ",
              "For more information see the ", m("a[href=https://github.com/chromy/ink-proof]", "ink-proof github page"), "."
              ),

            m("p.f6",
              m("b", "Key"),
                Object.values(Data.statuses).map(s => m("", [s.symbol, "=", s.name])),
              ),


          ];
        }
      };

      const ResultKeyValueRow = {
        view(vnode) {
          const k = vnode.attrs.k;
          const v = vnode.attrs.v;
          const kind = resultItemKind(k, v);

          if (kind === "null") {
            return m("tr",
              m("td", k),
              m("td", m(".code.gray", "NULL")),
            );
          } else if (kind === "file") {
            return m("tr", m("td", k), m("td", m(m.route.Link, {
              href: `/file/${v}`,
              class: 'link',
              }, v),
            ));
          } else if (kind === "list") {
            return m("tr", m("td", k), m("td.code", v.join(" ")));
          } else {
            return m("tr", m("td", k), m("td", v));
          }
        },
      };

      function resultItemKind(key, value) {
        const isPath = key.endsWith("Path");
        const isList = value instanceof Array;
        const isNullValue = value === null;
        if (isNullValue) {
          return 'null';
        }
        if (isPath) {
          return 'file';
        }
        if (isList) {
          return 'list';
        }
        return 'unknown';
      }

      const ResultEverything = {
        view(vnode) {
          const resultIndex = vnode.attrs.resultIndex;
          const result = Data.results[resultIndex];
          const program = Data.programByName[result.program];
          const example = Data.exampleByName[result.example];
          const status = Data.statuses[result.status];
          return m("table", Object.entries(result).map(([k, v]) => {
            return m(ResultKeyValueRow, {k, v})
          }));
        },
      };

      const ResultSummaryItem = {
        view(vnode) {
          const resultIndex = vnode.attrs.resultIndex;
          const result = Data.results[resultIndex];
          const item = vnode.attrs.item;
          const k = item.name;
          const v = result[k];
          const kind = resultItemKind(k, v);
          if (kind === "null") {
            return m("p", item.humanName, ": " , m(".code.gray", "NULL"));
          }

          if (kind === "file") {
            return m("p", item.humanName, ": " , m("span.code", m(FileView, {path: v})));
          }

          if (kind === "list") {
            return m("p", item.humanName, ": " , m("span.code", v.join(" ")));
          }

          return m("p", item.humanName, ": " , m("span.code", v));
        }
      };

      const ResultSummary = {
        view(vnode) {
          const resultIndex = vnode.attrs.resultIndex;
          const result = Data.results[resultIndex]
          const program = Data.programByName[result.program];
          const example = Data.exampleByName[result.example];
          const status = Data.statuses[result.status];
          return [
            (result.status === "CRASHED") ? [
              m(".fl.w-50.pr2",
                m("p", "stderr"),
                m(FileView, {path: result.errPath}),
              ),
              m(".fl.w-50",
                m("p", "stdout"),
                m(FileView, {path: result.outPath}),
              ),
            ] : (result.status === "INFRA_ERROR") ? [
                m("p", "Exception"),
                m("pre", result.infraError),
            ] : status.summary.map(item => m(ResultSummaryItem, {resultIndex, item})),

            //[
            //  m(".fl.w-33.pr2",
            //    m("p", "Expected output"),
            //    m(FileView, {path: example.expectedPath}),
            //  ),
            //  m(".fl.w-33.pr2",
            //    m("p", "Actual output"),
            //    m(FileView, {path: result.outPath}),
            //  ),
            //  m(".fl.w-33",
            //    m("p", "Diff"),
            //    m(FileView, {path: result.diffPath}),
            //  ),
            //],
            ];
        },
      };

      const FocusResult = {
        view(vnode) {
          const resultIndex = vnode.attrs.resultIndex;
          const showEverything = vnode.attrs.showEverything;
          const result = Data.results[resultIndex];
          const program = Data.programByName[result.program];
          const example = Data.exampleByName[result.example];
          const status = Data.statuses[result.status];

          return [
            m("h1",

                m(m.route.Link, {
                  href: `/program/${program.name}`,
                  class: 'link',
                  }, program.name),

              " x ",

                m(m.route.Link, {
                  href: `/example/${example.name}`,
                  class: 'link',
                  }, example.name),
              " ",
              m("span.f3.gray", example.metadata.oneLineDescription),
            ),
            m("h1", result.status, " ", m("span.f4.gray", status.description)),

            m(m.route.Link, {
              href: m.buildPathname("/result/:resultIndex", showEverything ? {
                resultIndex,
              } : {
                resultIndex,
                showEverything: true,
              }),
              class: 'link',
            }, showEverything ? "Show summary" : "Show everything"),
            showEverything ? m(ResultEverything, {resultIndex}) : m(ResultSummary, {resultIndex}),
          ];
        }
      };

      const Nav = {
        view() {
          return m(".bb.tc.center",
              m("span.f6.f5-l.black-80.pa3.ph4-l", "ink-proof"),
              m(m.route.Link, {
                href: `/help`,
                class: 'f6 f5-l link bg-animate black-80 hover-bg-lightest-blue dib pa3 ph4-l',
              }, "Help"),
              " ",
              m(m.route.Link, {
                href: `/metadata`,
                class: 'f6 f5-l link bg-animate black-80 hover-bg-lightest-blue dib pa3 ph4-l',
              }, "Metadata"),

            );
        }}


      const Overview = {
        view() {
          return [
            m("table.center",
              m("tr", m("th"), m("th"), Data.programs.map(p => m("th", {
                    class: m.route.param("programName") === p.name
                    ? "bg-light-yellow"
                    : "hover-bg-light-yellow",
                  },
                m(m.route.Link, {
                  href: `/program/${p.name}`,
                  class: 'link',
                  }, p.name)),
              )),
              Data.examples.map((e, i) => m("tr",
                m("td", {
                    class: m.route.param("exampleName") === e.name
                    ? "bg-light-yellow"
                    : "hover-bg-light-yellow",
                  },
                  m(m.route.Link, {
                    href: `/example/${e.name}`,
                    class: 'link code',
                  }, e.name),
                ),
                m("td.tc", m(m.route.Link, {
                  href: `/golden/${e.name}`,
                  class: 'link',
                }, "💛")),
                Data.programs.map(p => {
                  const result = Data.getResult(p, e);
                  if (result === null) {
                    return m("td");
                  }
                  const statusName = result.status;
                  const status = Data.statuses[statusName];
                  const resultIndex = m.route.param("resultIndex");
                  const index = Data.results.indexOf(result);
                  return m("td.tc", {
                    class: index == resultIndex
                    ? "bg-light-yellow"
                    : "hover-bg-light-yellow",
                  }, m(m.route.Link, {
                    href: `/result/${index}`,
                    class: 'link',
                  }, status.symbol));
                }),
              )),
            ),

          ];
         }
      };

      const OverviewWithFocus = {
        view(vnode) {
          return [
            m(".fl.w-30", m(".pa3", m(Overview))),
            m(".fl.w-70.bl", m(Nav), m(".pa3", vnode.children)),
          ];
        },
      }

      async function main() {
        Data.load();
        const result = await fetch('summary.json');
        const data = await result.json();
        const root = document.querySelector('main');
        m.route(root, "/help", {

          // "/": {
          //   render() {
          //     return m(OverviewWithFocus, m(FocusNothing));
          //   },
          // },

          "/example/:exampleName": {
            render(vnode) {
              return m(OverviewWithFocus, m(FocusExample, {
                exampleName: vnode.attrs.exampleName,
              }));
            },
          },

          "/golden/:exampleName": {
            render(vnode) {
              return m(OverviewWithFocus, m(FocusGolden, {
                exampleName: vnode.attrs.exampleName,
              }));
            },
          },

          "/program/:programName": {
            render(vnode) {
              return m(OverviewWithFocus, m(FocusProgram, {
                programName: vnode.attrs.programName,
              }));
            },
          },

          "/result/:resultIndex": {
            render(vnode) {
              return m(OverviewWithFocus, m(FocusResult, {
                resultIndex: vnode.attrs.resultIndex,
                showEverything: vnode.attrs.showEverything,
              }));
            },
          },

          "/help": {
            render(vnode) {
              return m(OverviewWithFocus, m(FocusHelp));
            },
          },

          "/metadata": {
            render(vnode) {
              return m(OverviewWithFocus, m(FocusMetadata));
            },
          },

          "/file/:path": {
            render(vnode) {
              return m(OverviewWithFocus, m(FocusFile, {
                path: vnode.attrs.path,
              }));
            },
          },

        });
      }

      main();

    </script>
  </body>
</html>
